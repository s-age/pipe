openapi: 3.0.0
info:
  title: Pipe CLI Web API
  version: 1.0.0
paths:
  /api/session/start:
    post:
      summary: Create a new session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartSessionRequest'
      responses:
        '200':
          description: Session created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_id:
                    type: string
        '422':
          description: Validation error
        '500':
          description: Internal server error
  /api/sessions:
    get:
      summary: Get all sessions
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      type: object # TODO: Define Session schema
        '500':
          description: Internal server error
  /api/session/{session_id}:
    get:
      summary: Get a specific session
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session to retrieve
      responses:
        '200':
          description: Session data
          content:
            application/json:
              schema:
                type: object
                properties:
                  session:
                    type: object # TODO: Define Session schema
        '404':
          description: Session not found
        '500':
          description: Internal server error
    delete:
      summary: Delete a session
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session to delete
      responses:
        '200':
          description: Session deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '500':
          description: Internal server error
  /api/session/{session_id}/turn/{turn_index}:
    delete:
      summary: Delete a specific turn from a session
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: turn_index
          schema:
            type: integer
          required: true
          description: The index of the turn to delete
      responses:
        '200':
          description: Turn deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Turn index out of range
        '404':
          description: Session not found
        '500':
          description: Internal server error
  /api/session/{session_id}/turns/{turn_index}:
    patch:
      summary: Edit a specific turn in a session
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: turn_index
          schema:
            type: integer
          required: true
          description: The index of the turn to edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object # Dynamic content, so just object
      responses:
        '200':
          description: Turn updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: No data provided or turn index out of range
        '403':
          description: Value error
        '404':
          description: Session not found
        '500':
          description: Internal server error
  /api/session/{session_id}/meta:
    patch:
      summary: Edit session metadata
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditSessionMetaRequest'
      responses:
        '200':
          description: Session metadata updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error
  /api/session/{session_id}/todos:
    patch:
      summary: Edit session todos
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditTodosRequest'
      responses:
        '200':
          description: Session todos updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error
  /api/session/{session_id}/references:
    patch:
      summary: Edit session references
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditReferencesRequest'
      responses:
        '200':
          description: Session references updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error
      /api/session/{session_id}/references/{reference_index}/persist:
      patch:      summary: Edit reference persist state
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: reference_index
          schema:
            type: integer
          required: true
          description: The index of the reference to edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditReferencePersistRequest'
      responses:
        '200':
          description: Reference persist state updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '400':
          description: Reference index out of range
        '500':
          description: Internal server error
      /api/session/{session_id}/references/{reference_index}/ttl:
      patch:      summary: Edit reference TTL
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: reference_index
          schema:
            type: integer
          required: true
          description: The index of the reference to edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditReferenceTtlRequest'
      responses:
        '200':
          description: Reference TTL updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '400':
          description: Reference index out of range
        '500':
          description: Internal server error
  /api/session/{session_id}/todos:
    delete:
      summary: Delete all todos from a session
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      responses:
        '200':
          description: Todos deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '404':
          description: Session not found
        '500':
          description: Internal server error
  /api/session/fork/{fork_index}:
    post:
      summary: Fork a session
      parameters:
        - in: path
          name: fork_index
          schema:
            type: integer
          required: true
          description: The turn index to fork from
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForkSessionRequest'
      responses:
        '200':
          description: Session Forked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  new_session_id:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '400':
          description: Fork turn index out of range
        '500':
          description: Internal server error
  /api/session/{session_id}/instruction:
    post:
      summary: Send an instruction to a session
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendInstructionRequest'
      responses:
        '200':
          description: Instruction sent successfully (streaming response)
          content:
            text/event-stream:
              schema:
                type: string
        '400':
          description: Too many tasks in processing pool
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error
  /api/session/{session_id}/turns:
    get:
      summary: Get session turns
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: query
          name: since
          schema:
            type: integer
            default: 0
          description: The index from which to retrieve turns
      responses:
        '200':
          description: List of turns
          content:
            application/json:
              schema:
                type: object
                properties:
                  turns:
                    type: array
                    items:
                      type: object # TODO: Define Turn schema
        '404':
          description: Session not found
        '500':
          description: Internal server error
  /api/settings:
    get:
      summary: Get application settings
      responses:
        '200':
          description: Application settings
          content:
            application/json:
              schema:
                type: object
                properties:
                  settings:
                    type: object # TODO: Define Settings schema
        '500':
          description: Internal server error
components:
  schemas:
    StartSessionRequest:
      type: object
      properties:
        purpose:
          type: string
        background:
          type: string
        instruction:
          type: string
        roles:
          type: array
          items:
            type: string
          nullable: true
        parent:
          type: string
          nullable: true
        references:
          type: array
          items:
            $ref: '#/components/schemas/Reference'
          nullable: true
        artifacts:
          type: array
          items:
            type: string
          nullable: true
        procedure:
          type: string
          nullable: true
        multi_step_reasoning_enabled:
          type: boolean
          default: false
        hyperparameters:
          $ref: '#/components/schemas/Hyperparameters'
          nullable: true
      required:
        - purpose
        - background
        - instruction
    EditSessionMetaRequest:
      type: object
      properties:
        purpose:
          type: string
          nullable: true
        background:
          type: string
          nullable: true
        roles:
          type: array
          items:
            type: string
          nullable: true
        artifacts:
          type: array
          items:
            type: string
          nullable: true
        procedure:
          type: string
          nullable: true
        multi_step_reasoning_enabled:
          type: boolean
          nullable: true
        token_count:
          type: integer
          nullable: true
        hyperparameters:
          $ref: '#/components/schemas/Hyperparameters'
          nullable: true
    EditTodosRequest:
      type: object
      properties:
        todos:
          type: array
          items:
            $ref: '#/components/schemas/TodoItem'
      required:
        - todos
    EditReferencesRequest:
      type: object
      properties:
        references:
          type: array
          items:
            $ref: '#/components/schemas/Reference'
      required:
        - references
    EditReferencePersistRequest:
      type: object
      properties:
        persist:
          type: boolean
      required:
        - persist
    EditReferenceTtlRequest:
      type: object
      properties:
        ttl:
          type: integer
          minimum: 0
          description: The new time-to-live value, must be a non-negative integer.
      required:
        - ttl
    ForkSessionRequest:
      type: object
      properties:
        session_id:
          type: string
      required:
        - session_id
    SendInstructionRequest:
      type: object
      properties:
        instruction:
          type: string
      required:
        - instruction
    Hyperparameters:
      type: object
      properties:
        temperature:
          type: number
          nullable: true
        top_p:
          type: number
          nullable: true
        top_k:
          type: number
          nullable: true

    Reference:
      type: object
      properties:
        path:
          type: string
        disabled:
          type: boolean
          default: false
        ttl:
          type: integer
          nullable: true
        persist:
          type: boolean
          default: false
      required:
        - path
    TodoItem:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
          default: ""
        checked:
          type: boolean
          default: false
      required:
        - title
