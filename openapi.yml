openapi: 3.0.0
info:
  title: Pipe CLI Web API
  version: 1.0.0
paths:
  # V1 API Endpoints

  # BFF (Backend for Frontend) Endpoints
  /api/v1/bff/session-dashboard/{session_id}:
    get:
      summary: Get session dashboard with tree (BFF)
      description: Returns session tree, current session details, and settings in a single request
      tags:
        - v1
        - bff
      x-aggregated-actions:
        - session_tree
        - session/{session_id}
        - settings
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session to retrieve
      responses:
        '200':
          description: Session dashboard data
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_tree:
                    type: array
                    description: List of all sessions
                    items:
                      type: object
                  current_session:
                    type: object
                    description: Details of the current session
                  settings:
                    type: object
                    description: System settings
        '404':
          description: Session not found
        '500':
          description: Internal server error

  # Session Tree (v1)
  /api/v1/session_tree:
    get:
      summary: Get session tree (v1)
      tags:
        - v1
      responses:
        '200':
          description: List of sessions in tree structure
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      type: object
        '500':
          description: Internal server error

  # Session Start (v1)
  /api/v1/session/start:
    post:
      summary: Start a new session (v1)
      tags:
        - v1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartSessionRequest'
      responses:
        '200':
          description: Session created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_id:
                    type: string
        '422':
          description: Validation error
        '500':
          description: Internal server error

  # Generic v1 dispatcher
  /api/v1/{action}:
    get:
      summary: Generic v1 API dispatcher (GET)
      tags:
        - v1
      parameters:
        - in: path
          name: action
          schema:
            type: string
          required: true
          description: Action path (e.g., 'session_tree')
      responses:
        '200':
          description: Success
        '404':
          description: Unknown action
        '500':
          description: Internal server error
    post:
      summary: Generic v1 API dispatcher (POST)
      tags:
        - v1
      parameters:
        - in: path
          name: action
          schema:
            type: string
          required: true
          description: Action path
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Success
        '404':
          description: Unknown action
        '500':
          description: Internal server error

  # Legacy Endpoints (Deprecated - use v1 instead)



























  # --- Singular form routes to match implementation in src/pipe/web/app.py ---
  /api/v1/session/start:
    post:
      summary: Start a new session (singular path used by the Flask app)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartSessionRequest'
      responses:
        '200':
          description: Session created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_id:
                    type: string
        '422':
          description: Validation error
        '500':
          description: Internal server error

  /api/v1/session/{session_id}:
    get:
      summary: Get a specific session (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session to retrieve
      responses:
        '200':
          description: Session data
          content:
            application/json:
              schema:
                type: object
                properties:
                  session:
                    type: object
        '404':
          description: Session not found
        '500':
          description: Internal server error
    delete:
      summary: Delete a session (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session to delete
      responses:
        '200':
          description: Session deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '500':
          description: Internal server error

  /api/v1/session/{session_id}/turn/{turn_index}:
    delete:
      summary: Delete a specific turn from a session (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: turn_index
          schema:
            type: integer
          required: true
          description: The index of the turn to delete
      responses:
        '200':
          description: Turn deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Turn index out of range
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/v1/session/{session_id}/turns/{turn_index}:
    patch:
      summary: Edit a specific turn in a session (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: turn_index
          schema:
            type: integer
          required: true
          description: The index of the turn to edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Turn updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: No data provided or turn index out of range
        '403':
          description: Value error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/v1/session/{session_id}/meta:
    patch:
      summary: Edit session metadata (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditSessionMetaRequest'
      responses:
        '200':
          description: Session metadata updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/v1/session/{session_id}/todos:
    patch:
      summary: Edit session todos (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditTodosRequest'
      responses:
        '200':
          description: Session todos updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error
    delete:
      summary: Delete all todos from a session (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      responses:
        '200':
          description: Todos deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/v1/session/{session_id}/references:
    patch:
      summary: Edit session references (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditReferencesRequest'
      responses:
        '200':
          description: Session references updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/v1/session/{session_id}/references/{reference_index}/persist:
    patch:
      summary: Edit reference persist state (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: reference_index
          schema:
            type: integer
          required: true
          description: The index of the reference to edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditReferencePersistRequest'
      responses:
        '200':
          description: Reference persist state updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '400':
          description: Reference index out of range
        '500':
          description: Internal server error

  /api/v1/session/{session_id}/references/{reference_index}/ttl:
    patch:
      summary: Edit reference TTL (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: reference_index
          schema:
            type: integer
          required: true
          description: The index of the reference to edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditReferenceTtlRequest'
      responses:
        '200':
          description: Reference TTL updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '400':
          description: Reference index out of range
        '500':
          description: Internal server error

  /api/v1/session/{session_id}/hyperparameters:
    patch:
      summary: Edit only hyperparameters for a session (temperature, top_p/topP, top_k/topK)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditHyperparametersRequest'
      responses:
        '200':
          description: Session hyperparameters updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: No data provided or no hyperparameter fields
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/v1/session/fork/{fork_index}:
    post:
      summary: Fork a session from a specific turn (singular path used by Flask app)
      parameters:
        - in: path
          name: fork_index
          schema:
            type: integer
          required: true
          description: The turn index to fork from
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                session_id:
                  type: string
      responses:
        '200':
          description: Session forked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  new_session_id:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '400':
          description: Fork turn index out of range
        '500':
          description: Internal server error

  /api/v1/session/{session_id}/instruction:
    post:
      summary: Send an instruction to a session (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendInstructionRequest'
      responses:
        '200':
          description: Instruction sent successfully (streaming response)
          content:
            text/event-stream:
              schema:
                type: string
        '400':
          description: Too many tasks in processing pool
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/v1/session/{session_id}/turns:
    get:
      summary: Get session turns (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: query
          name: since
          schema:
            type: integer
            default: 0
          description: The index from which to retrieve turns
      responses:
        '200':
          description: List of turns
          content:
            application/json:
              schema:
                type: object
                properties:
                  turns:
                    type: array
                    items:
                      type: object
        '404':
          description: Session not found
        '500':
          description: Internal server error

components:
  schemas:
    StartSessionRequest:
      type: object
      properties:
        purpose:
          type: string
        background:
          type: string
        instruction:
          type: string
        roles:
          type: array
          items:
            type: string
          nullable: true
        parent:
          type: string
          nullable: true
        references:
          type: array
          items:
            $ref: '#/components/schemas/Reference'
          nullable: true
        artifacts:
          type: array
          items:
            type: string
          nullable: true
        procedure:
          type: string
          nullable: true
        multi_step_reasoning_enabled:
          type: boolean
          default: false
        hyperparameters:
          $ref: '#/components/schemas/Hyperparameters'
          nullable: true
      required:
        - purpose
        - background
        - instruction
    EditSessionMetaRequest:
      type: object
      properties:
        purpose:
          type: string
          nullable: true
        background:
          type: string
          nullable: true
        roles:
          type: array
          items:
            type: string
          nullable: true
        artifacts:
          type: array
          items:
            type: string
          nullable: true
        procedure:
          type: string
          nullable: true
        multi_step_reasoning_enabled:
          type: boolean
          nullable: true
        token_count:
          type: integer
          nullable: true
        hyperparameters:
          $ref: '#/components/schemas/Hyperparameters'
          nullable: true
    EditTodosRequest:
      type: object
      properties:
        todos:
          type: array
          items:
            $ref: '#/components/schemas/TodoItem'
      required:
        - todos
    EditReferencesRequest:
      type: object
      properties:
        references:
          type: array
          items:
            $ref: '#/components/schemas/Reference'
      required:
        - references
    EditReferencePersistRequest:
      type: object
      properties:
        persist:
          type: boolean
      required:
        - persist
    EditReferenceTtlRequest:
      type: object
      properties:
        ttl:
          type: integer
          minimum: 0
          description: The new time-to-live value, must be a non-negative integer.
      required:
        - ttl
    ForkSessionRequest:
      type: object
      properties:
        session_id:
          type: string
          description: The ID of the session to fork
      required:
        - session_id
    SendInstructionRequest:
      type: object
      properties:
        instruction:
          type: string
      required:
        - instruction
    Hyperparameters:
      type: object
      properties:
        temperature:
          type: number
          nullable: true
        top_p:
          type: number
          nullable: true
        top_k:
          type: number
          nullable: true
    EditHyperparametersRequest:
      type: object
      description: |
        Accepts hyperparameter fields to update. Supports snake_case keys (`top_p`, `top_k`)
        and camelCase variants (`topP`, `topK`). Only provided fields will be updated.
      properties:
        temperature:
          type: number
          nullable: true
        top_p:
          type: number
          nullable: true
        topP:
          type: number
          nullable: true
        top_k:
          type: integer
          nullable: true
        topK:
          type: integer
          nullable: true
    Reference:
      type: object
      properties:
        path:
          type: string
        disabled:
          type: boolean
          default: false
        ttl:
          type: integer
          nullable: true
        persist:
          type: boolean
          default: false
      required:
        - path
    TodoItem:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
          default: ''
        checked:
          type: boolean
          default: false
      required:
        - title
