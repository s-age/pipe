openapi: 3.0.0
info:
  title: Pipe CLI Web API
  version: 1.0.0
paths:
  # 1. セッション開始
  /api/sessions/start: # リソースコレクションに対するアクションとして修正
    post:
      summary: Start a new session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartSessionRequest'
      responses:
        '200':
          description: Session created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_id:
                    type: string
        '422':
          description: Validation error
        '500':
          description: Internal server error

  # 2. 全セッション取得 (RESTful: 複数形)
  /api/sessions:
    get:
      summary: Get all sessions
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      type: object # TODO: Define Session schema
        '500':
          description: Internal server error

  # 3. 単一セッションの操作 (RESTful: 複数形 + ID)
  /api/sessions/{session_id}:
    get:
      summary: Get a specific session
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session to retrieve
      responses:
        '200':
          description: Session data
          content:
            application/json:
              schema:
                type: object
                properties:
                  session:
                    type: object # TODO: Define Session schema
        '404':
          description: Session not found
        '500':
          description: Internal server error
    delete:
      summary: Delete a session
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session to delete
      responses:
        '200':
          description: Session deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '500':
          description: Internal server error

  # 4. 特定ターンの削除 (RESTful: 複数形 + インデックス)
  /api/sessions/{session_id}/turns/{turn_index}:
    delete:
      summary: Delete a specific turn from a session
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: turn_index
          schema:
            type: integer
          required: true
          description: The index of the turn to delete
      responses:
        '200':
          description: Turn deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Turn index out of range
        '404':
          description: Session not found
        '500':
          description: Internal server error

    patch: # ターン全体の編集
      summary: Edit a specific turn in a session
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: turn_index
          schema:
            type: integer
          required: true
          description: The index of the turn to edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object # Dynamic content, so just object
      responses:
        '200':
          description: Turn updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: No data provided or turn index out of range
        '403':
          description: Value error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  # 5. メタデータの編集
  /api/sessions/{session_id}/meta:
    patch:
      summary: Edit session metadata
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditSessionMetaRequest'
      responses:
        '200':
          description: Session metadata updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  # 6. ToDoリストの編集と一括削除
  /api/sessions/{session_id}/todos:
    patch:
      summary: Edit session todos (replace/update list)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditTodosRequest'
      responses:
        '200':
          description: Session todos updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error

    delete:
      summary: Delete all todos from a session
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      responses:
        '200':
          description: Todos deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '404':
          description: Session not found
        '500':
          description: Internal server error

  # 7. 参照リストの編集
  /api/sessions/{session_id}/references:
    patch:
      summary: Edit session references (replace/update list)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditReferencesRequest'
      responses:
        '200':
          description: Session references updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  # 8. 個別参照のpersist状態編集 (YAML構造を修正し、パスを複数形に変更)
  /api/sessions/{session_id}/references/{reference_index}/persist:
    patch:
      summary: Edit reference persist state
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: reference_index
          schema:
            type: integer
          required: true
          description: The index of the reference to edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditReferencePersistRequest'
      responses:
        '200':
          description: Reference persist state updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '400':
          description: Reference index out of range
        '500':
          description: Internal server error

  # 9. 個別参照のTTL編集 (YAML構造を修正し、パスを複数形に変更)
  /api/sessions/{session_id}/references/{reference_index}/ttl:
    patch:
      summary: Edit reference TTL
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: reference_index
          schema:
            type: integer
          required: true
          description: The index of the reference to edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditReferenceTtlRequest'
      responses:
        '200':
          description: Reference TTL updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '400':
          description: Reference index out of range
        '500':
          description: Internal server error

  # 10. セッションのフォーク (パスを複数形に変更)
  /api/sessions/{session_id}/fork:
    post:
      summary: Fork a session from a specific turn
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session to fork
      requestBody:
        required: true
        content:
          application/json:
            schema:
              # ForkSessionRequestをターンインデックスをボディに持つように修正
              $ref: '#/components/schemas/ForkSessionRequest'
      responses:
        '200':
          description: Session Forked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  new_session_id:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '400':
          description: Fork turn index out of range
        '500':
          description: Internal server error

  # 11. インストラクション送信 (パスを複数形に変更)
  /api/sessions/{session_id}/instruction:
    post:
      summary: Send an instruction to a session
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendInstructionRequest'
      responses:
        '200':
          description: Instruction sent successfully (streaming response)
          content:
            text/event-stream:
              schema:
                type: string
        '400':
          description: Too many tasks in processing pool
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  # 12. ターン取得 (パスを複数形に変更)
  /api/sessions/{session_id}/turns:
    get:
      summary: Get session turns
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: query
          name: since
          schema:
            type: integer
            default: 0
          description: The index from which to retrieve turns
      responses:
        '200':
          description: List of turns
          content:
            application/json:
              schema:
                type: object
                properties:
                  turns:
                    type: array
                    items:
                      type: object # TODO: Define Turn schema
        '404':
          description: Session not found
        '500':
          description: Internal server error

  # 13. 設定の取得
  /api/settings:
    get:
      summary: Get application settings
      responses:
        '200':
          description: Application settings
          content:
            application/json:
              schema:
                type: object
                properties:
                  settings:
                    type: object # TODO: Define Settings schema
        '500':
          description: Internal server error

  # --- Singular form routes to match implementation in src/pipe/web/app.py ---
  /api/session/start:
    post:
      summary: Start a new session (singular path used by the Flask app)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartSessionRequest'
      responses:
        '200':
          description: Session created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_id:
                    type: string
        '422':
          description: Validation error
        '500':
          description: Internal server error

  /api/session/{session_id}:
    get:
      summary: Get a specific session (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session to retrieve
      responses:
        '200':
          description: Session data
          content:
            application/json:
              schema:
                type: object
                properties:
                  session:
                    type: object
        '404':
          description: Session not found
        '500':
          description: Internal server error
    delete:
      summary: Delete a session (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session to delete
      responses:
        '200':
          description: Session deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '500':
          description: Internal server error

  /api/session/{session_id}/turn/{turn_index}:
    delete:
      summary: Delete a specific turn from a session (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: turn_index
          schema:
            type: integer
          required: true
          description: The index of the turn to delete
      responses:
        '200':
          description: Turn deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Turn index out of range
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/session/{session_id}/turns/{turn_index}:
    patch:
      summary: Edit a specific turn in a session (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: turn_index
          schema:
            type: integer
          required: true
          description: The index of the turn to edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Turn updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: No data provided or turn index out of range
        '403':
          description: Value error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/session/{session_id}/meta:
    patch:
      summary: Edit session metadata (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditSessionMetaRequest'
      responses:
        '200':
          description: Session metadata updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/session/{session_id}/todos:
    patch:
      summary: Edit session todos (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditTodosRequest'
      responses:
        '200':
          description: Session todos updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error
    delete:
      summary: Delete all todos from a session (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      responses:
        '200':
          description: Todos deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/session/{session_id}/references:
    patch:
      summary: Edit session references (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditReferencesRequest'
      responses:
        '200':
          description: Session references updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/session/{session_id}/references/{reference_index}/persist:
    patch:
      summary: Edit reference persist state (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: reference_index
          schema:
            type: integer
          required: true
          description: The index of the reference to edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditReferencePersistRequest'
      responses:
        '200':
          description: Reference persist state updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '400':
          description: Reference index out of range
        '500':
          description: Internal server error

  /api/session/{session_id}/references/{reference_index}/ttl:
    patch:
      summary: Edit reference TTL (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: path
          name: reference_index
          schema:
            type: integer
          required: true
          description: The index of the reference to edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditReferenceTtlRequest'
      responses:
        '200':
          description: Reference TTL updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '400':
          description: Reference index out of range
        '500':
          description: Internal server error

  /api/session/{session_id}/hyperparameters:
    patch:
      summary: Edit only hyperparameters for a session (temperature, top_p/topP, top_k/topK)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EditHyperparametersRequest'
      responses:
        '200':
          description: Session hyperparameters updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: No data provided or no hyperparameter fields
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/session/fork/{fork_index}:
    post:
      summary: Fork a session from a specific turn (singular path used by Flask app)
      parameters:
        - in: path
          name: fork_index
          schema:
            type: integer
          required: true
          description: The turn index to fork from
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                session_id:
                  type: string
      responses:
        '200':
          description: Session forked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  new_session_id:
                    type: string
        '422':
          description: Validation error
        '404':
          description: Session not found
        '400':
          description: Fork turn index out of range
        '500':
          description: Internal server error

  /api/session/{session_id}/instruction:
    post:
      summary: Send an instruction to a session (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendInstructionRequest'
      responses:
        '200':
          description: Instruction sent successfully (streaming response)
          content:
            text/event-stream:
              schema:
                type: string
        '400':
          description: Too many tasks in processing pool
        '422':
          description: Validation error
        '404':
          description: Session not found
        '500':
          description: Internal server error

  /api/session/{session_id}/turns:
    get:
      summary: Get session turns (singular path)
      parameters:
        - in: path
          name: session_id
          schema:
            type: string
          required: true
          description: The ID of the session
        - in: query
          name: since
          schema:
            type: integer
            default: 0
          description: The index from which to retrieve turns
      responses:
        '200':
          description: List of turns
          content:
            application/json:
              schema:
                type: object
                properties:
                  turns:
                    type: array
                    items:
                      type: object
        '404':
          description: Session not found
        '500':
          description: Internal server error

components:
  schemas:
    StartSessionRequest:
      type: object
      properties:
        purpose:
          type: string
        background:
          type: string
        instruction:
          type: string
        roles:
          type: array
          items:
            type: string
          nullable: true
        parent:
          type: string
          nullable: true
        references:
          type: array
          items:
            $ref: '#/components/schemas/Reference'
          nullable: true
        artifacts:
          type: array
          items:
            type: string
          nullable: true
        procedure:
          type: string
          nullable: true
        multi_step_reasoning_enabled:
          type: boolean
          default: false
        hyperparameters:
          $ref: '#/components/schemas/Hyperparameters'
          nullable: true
      required:
        - purpose
        - background
        - instruction
    EditSessionMetaRequest:
      type: object
      properties:
        purpose:
          type: string
          nullable: true
        background:
          type: string
          nullable: true
        roles:
          type: array
          items:
            type: string
          nullable: true
        artifacts:
          type: array
          items:
            type: string
          nullable: true
        procedure:
          type: string
          nullable: true
        multi_step_reasoning_enabled:
          type: boolean
          nullable: true
        token_count:
          type: integer
          nullable: true
        hyperparameters:
          $ref: '#/components/schemas/Hyperparameters'
          nullable: true
    EditTodosRequest:
      type: object
      properties:
        todos:
          type: array
          items:
            $ref: '#/components/schemas/TodoItem'
      required:
        - todos
    EditReferencesRequest:
      type: object
      properties:
        references:
          type: array
          items:
            $ref: '#/components/schemas/Reference'
      required:
        - references
    EditReferencePersistRequest:
      type: object
      properties:
        persist:
          type: boolean
      required:
        - persist
    EditReferenceTtlRequest:
      type: object
      properties:
        ttl:
          type: integer
          minimum: 0
          description: The new time-to-live value, must be a non-negative integer.
      required:
        - ttl
    ForkSessionRequest:
      type: object
      properties:
        # パスから{fork_index}を削除したため、ボディで渡す形に変更
        fork_index:
          type: integer
          description: The turn index to fork from
      required:
        - fork_index
    SendInstructionRequest:
      type: object
      properties:
        instruction:
          type: string
      required:
        - instruction
    Hyperparameters:
      type: object
      properties:
        temperature:
          type: number
          nullable: true
        top_p:
          type: number
          nullable: true
        top_k:
          type: number
          nullable: true
    EditHyperparametersRequest:
      type: object
      description: |
        Accepts hyperparameter fields to update. Supports snake_case keys (`top_p`, `top_k`)
        and camelCase variants (`topP`, `topK`). Only provided fields will be updated.
      properties:
        temperature:
          type: number
          nullable: true
        top_p:
          type: number
          nullable: true
        topP:
          type: number
          nullable: true
        top_k:
          type: integer
          nullable: true
        topK:
          type: integer
          nullable: true
    Reference:
      type: object
      properties:
        path:
          type: string
        disabled:
          type: boolean
          default: false
        ttl:
          type: integer
          nullable: true
        persist:
          type: boolean
          default: false
      required:
        - path
    TodoItem:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
          default: ''
        checked:
          type: boolean
          default: false
      required:
        - title
