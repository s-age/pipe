<!DOCTYPE html>
<html lang="en" data-color-mode="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conductor Sessions</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; background-color: #f8f9fa; font-size: 14px; color: #343a40; height: 100vh; overflow: hidden; }
        .column { height: 100vh; overflow-y: auto; padding: 15px; box-sizing: border-box; }
        
        /* Column 1: Sessions List */
        #sessions-column { flex: 2; background-color: #343a40; color: #f8f9fa; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 10; }
        #sessions-column h2 { margin-top: 0; font-size: 1.4em; color: #ffffff; border-bottom: 1px solid #495057; padding-bottom: 10px; margin-bottom: 15px; }
        #sessions-column ul { list-style: none; padding: 0; margin: 0; }
        #sessions-column li { margin-bottom: 8px; }
        #sessions-column a { text-decoration: none; color: #adb5bd; display: block; padding: 10px 12px; border-radius: 5px; transition: background-color 0.2s, color 0.2s; white-space: normal; word-wrap: break-word; }
        #sessions-column a:hover { background-color: #495057; color: #ffffff; }
        #sessions-column a.active { background-color: #666; color: white; font-weight: bold; }
        #sessions-column a .session-id { font-size: 0.7em; color: #eee8aa; display: block; margin-top: 4px; word-break: break-all; }

        /* Column 2: Turns List */
        #turns-column { flex: 6; background-color: #f0f2f5; padding: 0; display: flex; flex-direction: column; gap: 15px; }
        .turn { padding: 10px 15px; border-radius: 18px; box-shadow: 0 1px 1px rgba(0,0,0,0.05); width: 70%; position: relative; }
        .turn-header { font-weight: bold; margin-bottom: 5px; text-transform: capitalize; color: #6c757d; font-size: 0.85em; display: flex; justify-content: space-between; align-items: center; }
        .user_task { background-color: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .model_response, .function_calling, .tool_response { background-color: #ffffff; align-self: flex-start; border-bottom-left-radius: 2px; }
        .compressed_history { background-color: #fffbe6; align-self: center; width: 90%; border-left: 4px solid #ffc107; }
        .model_response .turn-content, .compressed_history .turn-content { padding: 1px 15px; } /* Padding for markdown */
        pre, textarea { background-color: transparent; padding: 0; border-radius: 0; border: none; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; width: 100%; min-height: auto; }
        .turn-content { margin-top: 5px; }
        .turn-content p { margin: 0; }
        .turn-header-controls { display: none; position: absolute; top: 5px; right: 10px; background-color: rgba(255,255,255,0.8); border-radius: 5px; padding: 2px; }
        .turn:hover .turn-header-controls { display: flex; }
        .welcome-message { text-align: center; color: #6c757d; margin-top: 50px; }

        /* Column 3: Meta & Actions */
        #meta-column { flex: 3; display: flex; flex-direction: column; background-color: #f8f9fa; border-left: 1px solid #dee2e6; overflow-y: hidden; height: 100%; }
        #meta-column h1, #meta-column h3, #meta-column h4 { margin-top: 0; margin-bottom: 0; } #meta-column h1 { color: #343a40; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.8em; }
        .session-meta { background-color: #fff; border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; }
        .session-meta .meta-item { margin-bottom: 10px; }
        .session-meta strong { display: block; color: #495057; margin-bottom: 5px; }
        .session-meta p, .session-meta pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; }
        .session-meta textarea { min-height: 60px; }
        .action-btn { background-color: #6c757d; color: white; border: none; padding: 4px 8px; font-size: 0.8em; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }
        .edit-btn { background-color: #ffc107; }
        .edit-btn:hover { background-color: #e0a800; }
        .copy-turn-btn { background-color: #007bff; }
        .copy-turn-btn:hover { background-color: #0069d9; }
        .edit-meta-btn { background-color: #fd7e14; }
        .edit-meta-btn:hover { background-color: #e66a00; }
        .save-btn { background-color: #28a745; }
        .save-btn:hover { background-color: #218838; }
        .send-instruction-btn { background-color: #28a745; }
        .send-instruction-btn:hover { background-color: #218838; }
        .cancel-btn { background-color: #6c757d; }
        .compress-btn { background-color: #17a2b8; }
        .compress-btn:hover { background-color: #138496; }
        .session-actions { margin-top: 20px; display: flex; gap: 10px; }
        #new-instruction-text { padding: 8px; border: 1px solid #dee2e6; border-radius: 8px; }

        .status-succeeded { color: #28a745; font-weight: bold; }
        .status-failed { color: #dc3545; font-weight: bold; }
        .tool-response-content pre { background-color: #e9ecef; padding: 5px; border-radius: 4px; }
        .markdown-body {
            background-color: #ffffff !important;
            color: #24292f !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css">
</head>
<body>
    <!-- Column 1: Session List -->
    <div id="sessions-column" class="column">
        <h2>Sessions</h2>
        <button class="action-btn save-btn" style="width: 100%; margin-bottom: 15px;" id="new-chat-button">+ New Chat</button>
        <ul>
            {% for session_id, meta in sessions %}
            <li>
                <a href="{{ url_for('view_session', session_id=session_id) }}" class="{{ 'active' if session_id == current_session_id else '' }}">
                    {{ meta.purpose }}
                    <span class="session-id">{{ session_id }}</span>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Column 2: Turns List -->
    <div id="turns-column" class="column">
        {% if current_session_id %}
        <div id="turns-column-header" style="position: sticky; top: 0; background-color: #f0f2f5; padding: 10px 20px; border-bottom: 1px solid #dee2e6; z-index: 5;">
            <h2>{{ session_data.purpose }} {% if context_limit > 0 and token_count is not none %}({{ ((context_limit - token_count) / context_limit * 100) | round(0, 'floor') }}% context left){% endif %}</h2>
        </div>
        {% endif %}

        {% if current_session_id %}
        <section id="turns-list-section" style="padding: 20px; display: flex; flex-direction: column; gap: 15px;">
            {% for turn in turns %}
                <div class="turn {{ turn.type }}" id="turn-{{ loop.index0 }}">
                                            <div class="turn-header">
                                            <span>
                                                <strong style="color: #007bff; margin-right: 10px;">{{ session_data.turns|length - loop.index0 }}:</strong>
                                                                            {% if turn.type == 'user_task' %}You
                                                                            {% elif turn.type == 'model_response' %}Model
                                                                            {% elif turn.type == 'function_calling' %}Function Calling
                                                                            {% elif turn.type == 'tool_response' %}Tool Response
                                                                            {% elif turn.type == 'compressed_history' %}Compressed
                                                                            {% else %}Unknown{% endif %}                                                <span style="font-weight: normal; color: #999; margin-left: 10px;">{{ turn.timestamp.replace('T', ' ').split('.')[0] if turn.timestamp else '' }}</span>
                                            </span>                        <div class="turn-header-controls">
                            {% if turn.type == 'model_response' %}
                            <button class="action-btn fork-btn" data-session-id="{{ current_session_id }}" data-fork-index="{{ (session_data.turns|length - 1) - loop.index0 }}">Fork</button>
                            {% endif %}
                            <button class="action-btn copy-turn-btn" data-turn-index="{{ loop.index0 }}">Copy</button>
                            {% if expert_mode %}
                            <button class="action-btn edit-btn" data-session-id="{{ current_session_id }}" data-turn-index="{{ loop.index0 }}" data-turn-type="{{ turn.type }}">Edit</button>
                            <button class="action-btn delete-btn" data-session-id="{{ current_session_id }}" data-turn-index="{{ loop.index0 }}">Delete</button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="turn-content">
                        {% if turn.type == 'user_task' %}
                            <pre class="editable" data-field="instruction">{{ turn.instruction }}</pre>
                        {% elif turn.type == 'model_response' or turn.type == 'compressed_history' %}
                            {% if turn.type == 'compressed_history' %}<p><strong><em>-- History Compressed --</em></strong></p>{% endif %}
                            <div class="raw-markdown" style="display: none;">{{ turn.content }}</div>
                            <div class="rendered-markdown markdown-body editable" data-field="content"></div>
                        {% elif turn.type == 'function_calling' %}
                            <pre>{{ turn.response }}</pre>
                        {% elif turn.type == 'tool_response' %}
                            <div class="tool-response-content">
                                <strong>Status: </strong>
                                <span class="status-{{ turn.response.status }}">{{ turn.response.status }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="welcome-message">
                <h1>Welcome</h1>
                <p>Select a session from the sidebar to view its details.</p>
            </div>
        {% endif %}
    </div>

    <!-- Column 3: Meta & Actions -->
    <div id="meta-column" class="column">
        {% if current_session_id %}
            <input type="hidden" id="current-session-id" value="{{ current_session_id }}">

            <section style="flex: 5 0 0; display: flex; flex-direction: column; box-sizing: border-box; min-height: 0;">
                <h3>Session Meta</h3>
                <div class="session-meta" id="session-meta-view" style="flex: 1; overflow-y: auto;">
                    <div class="meta-item">
                        <strong>Purpose:</strong>
                        <p class="editable-meta" data-field="purpose">{{ session_data.purpose }}</p>
                    </div>
                    <div class="meta-item">
                        <strong>Background:</strong>
                        <p class="editable-meta" data-field="background">{{ session_data.background }}</p>
                    </div>
                    <div class="meta-item">
                        <strong>Roles:</strong>
                        <p class="editable-meta" data-field="roles">{{ session_data.roles | join(', ') }}</p>
                    </div>
                    <div class="meta-item">
                        <strong>Multi-step Reasoning:</strong>
                        <p class="editable-meta" data-field="multi_step_reasoning_enabled">{{ "Enabled" if session_data.multi_step_reasoning_enabled else "Disabled" }}</p>
                    </div>
                    <div class="meta-item">
                        <strong>Hyperparameters:</strong>
                        {% if session_data.hyperparameters %}
                            <p class="editable-meta" data-field="hyperparameters">
                                Temp: {{ session_data.hyperparameters.temperature.value }},
                                Top P: {{ session_data.hyperparameters.top_p.value }},
                                Top K: {{ session_data.hyperparameters.top_k.value }}
                            </p>
                        {% endif %}
                    </div>
                    <div class="meta-item">
                        <strong>Todos:</strong>
                        <button class="action-btn" id="delete-todos-btn" data-session-id="{{ current_session_id }}" style="float: right; margin-bottom: 5px; background-color: #dc3545;">Delete All</button>
                        {% if session_data.todos and session_data.todos|length > 0 %}
                            <ul id="todos-list" style="list-style: none; padding-left: 0;">
                                {% for todo in session_data.todos %}
                                    <li style="margin-bottom: 10px;">
                                        <label style="cursor: pointer;">
                                            <input type="checkbox" class="todo-checkbox" data-index="{{ loop.index0 }}" {% if todo.checked %}checked{% endif %} style="margin-right: 8px;">
                                            <strong style="display: inline;">{{ todo.item }}</strong>
                                        </label>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>No todos for this session.</p>
                        {% endif %}
                    </div>
                    <div class="meta-item">
                        <strong>References:</strong>
                        <button class="action-btn" id="toggle-references-btn" data-session-id="{{ current_session_id }}" style="float: right; margin-bottom: 5px;">Toggle All</button>
                        {% if session_data.references and session_data.references|length > 0 %}
                            <ul id="references-list" style="list-style: none; padding-left: 0;">
                                {% for reference in session_data.references %}
                                    <li style="margin-bottom: 10px;">
                                        <label style="cursor: pointer; display: flex; align-items: center;">
                                            <input type="checkbox" class="reference-checkbox" data-index="{{ loop.index0 }}" {% if not reference.disabled %}checked{% endif %} style="margin-right: 8px;">
                                            <span style="word-break: break-all; {% if reference.disabled %}text-decoration: line-through; color: #888;{% endif %}">{{ reference.path }}</span>
                                        </label>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>No references for this session.</p>
                        {% endif %}
                    </div>
                </div>
                <button class="action-btn edit-meta-btn" data-session-id="{{ current_session_id }}">Edit Meta</button>
            </section>

            <section style="flex: 1; box-sizing: border-box;">
                <h3>Session Control</h3>
                <div class="session-actions">
                    <button class="action-btn delete-session-btn" data-session-id="{{ current_session_id }}">Delete Session</button>
                </div>
            </section>

            <section class="new-instruction-control" style="flex: 4; display: flex; flex-direction: column; box-sizing: border-box;">
                <h3>New Instruction</h3>
                <textarea id="new-instruction-text" placeholder="Enter your instruction here..." style="width: 100%; flex: 1; min-height: 80px; margin-bottom: 10px;"></textarea>
                <button class="action-btn send-instruction-btn" data-session-id="{{ current_session_id }}">Send Instruction</button>
            </section>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.marked) {
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                });
            }

            function handleResponse(response) {
                // If the response is not OK, we need to parse the JSON body
                // to get the detailed error message from the server.
                if (!response.ok) {
                    return response.json().then(errorData => {
                        let errorMessage = `HTTP error! status: ${response.status}`;
                        if (errorData && errorData.message) {
                            errorMessage = errorData.message;
                        }
                        if (errorData && errorData.details) {
                            errorMessage += `\n\n--- Details ---\n${errorData.details}`;
                        }
                        throw new Error(errorMessage);
                    }).catch(parsingError => {
                        // If parsing the error JSON fails, throw a generic error
                        throw new Error(`HTTP error! status: ${response.status}. Could not parse error response.`);
                    });
                }
                return response.json();
            }

            function forkSession(sessionId, forkIndex) {
                if (!confirm(`Are you sure you want to fork this session at turn index ${forkIndex}?`)) return;

                fetch(`/api/session/${sessionId}/fork/${forkIndex}`, { method: 'POST' })
                    .then(handleResponse)
                    .then(data => {
                        if (data.success && data.new_session_id) {
                            window.location.href = `/session/${data.new_session_id}`;
                        } else {
                            throw new Error(data.message || 'Failed to fork session.');
                        }
                    })
                    .catch(handleError);
            }

            function handleError(error) {
                console.error('Error:', error);
                alert('An error occurred: ' + error.message);
            }

            function renderMarkdown() {
                document.querySelectorAll('.model_response .turn-content, .compressed_history .turn-content').forEach(contentElement => {
                    const rawMarkdownDiv = contentElement.querySelector('.raw-markdown');
                    const renderedMarkdownDiv = contentElement.querySelector('.rendered-markdown');
                    if (rawMarkdownDiv && renderedMarkdownDiv && window.marked) {
                        renderedMarkdownDiv.innerHTML = marked.parse(rawMarkdownDiv.textContent || '');
                    }
                });
            }
            renderMarkdown();

            function fallbackCopyTextToClipboard(text) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.top = "0";
                textArea.style.left = "0";
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    return Promise.resolve();
                } catch (err) {
                    return Promise.reject(err);
                } finally {
                    document.body.removeChild(textArea);
                }
            }

            // Event Listeners
            document.getElementById('new-chat-button').addEventListener('click', () => window.location.href = '/new_session');

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const { sessionId, turnIndex, turnType } = this.dataset;
                    toggleEdit(this, sessionId, parseInt(turnIndex), turnType);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const { sessionId, turnIndex } = this.dataset;
                    deleteTurn(sessionId, parseInt(turnIndex));
                });
            });

            document.querySelectorAll('.fork-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const sessionId = this.dataset.sessionId;
                    const forkIndex = this.dataset.forkIndex;
                    forkSession(sessionId, parseInt(forkIndex));
                });
            });

            document.querySelectorAll('.copy-turn-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const turnIndex = this.dataset.turnIndex;
                    const turnElement = document.getElementById(`turn-${turnIndex}`);
                    const turnType = turnElement.classList.contains('model_response') ? 'model_response' :
                                     (turnElement.classList.contains('condensed_history') ? 'condensed_history' : 'user_task');

                    let textToCopy = '';
                    if (turnType === 'model_response' || turnType === 'condensed_history') {
                        textToCopy = turnElement.querySelector('.raw-markdown').textContent;
                    } else { // user_task
                        textToCopy = turnElement.querySelector('.editable').textContent;
                    }

                    const copyPromise = navigator.clipboard ? 
                        navigator.clipboard.writeText(textToCopy) : 
                        fallbackCopyTextToClipboard(textToCopy);

                    copyPromise.then(() => {
                        const originalText = this.textContent;
                        this.textContent = 'Copied!';
                        setTimeout(() => {
                            this.textContent = originalText;
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy turn content: ', err);
                        alert('Failed to copy');
                    });
                });
            });

            document.querySelectorAll('.edit-meta-btn').forEach(button => {
                button.addEventListener('click', function() {
                    toggleMetaEdit(this, this.dataset.sessionId);
                });
            });

            document.querySelectorAll('.delete-session-btn, .send-instruction-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const actionMap = { 'delete-session-btn': deleteSession, 'send-instruction-btn': sendInstruction };
                    const action = Object.keys(actionMap).find(cls => this.classList.contains(cls));
                    if(action) actionMap[action](this.dataset.sessionId);
                });
            });

            function deleteTurn(sessionId, turnIndex) {
                if (!confirm('Are you sure you want to delete this turn?')) return;
                fetch(`/api/session/${sessionId}/turn/${turnIndex}`, { method: 'DELETE' })
                    .then(handleResponse)
                    .then(data => data.success ? window.location.reload() : Promise.reject(new Error(data.message)))
                    .catch(handleError);
            }

            function deleteSession(sessionId) {
                if (!confirm('Are you sure you want to delete this entire session?')) return;
                fetch(`/api/session/${sessionId}`, { method: 'DELETE' })
                    .then(handleResponse)
                    .then(data => data.success ? (window.location.href = '/') : Promise.reject(new Error(data.message)))
                    .catch(handleError);
            }

            function toggleEdit(editButton, sessionId, turnIndex, turnType) {
                const turnElement = document.getElementById(`turn-${turnIndex}`);
                const contentDiv = turnElement.querySelector('.turn-content');
                const controls = editButton.parentElement;

                let editableElement, originalContent, fieldName;
                
                if (turnType === 'model_response' || turnType === 'condensed_history') {
                    editableElement = contentDiv.querySelector('.rendered-markdown');
                    originalContent = contentDiv.querySelector('.raw-markdown').textContent.trim();
                    fieldName = 'content';
                } else { // user_task
                    editableElement = contentDiv.querySelector('.editable');
                    originalContent = editableElement.textContent.trim();
                    fieldName = 'instruction';
                }

                const textarea = document.createElement('textarea');
                textarea.value = originalContent;
                textarea.style.width = '100%';
                textarea.style.minHeight = '120px';
                textarea.style.height = (editableElement.scrollHeight + 20) + 'px';
                textarea.style.boxSizing = 'border-box';
                textarea.style.padding = '10px';
                textarea.style.borderRadius = '5px';
                textarea.style.border = '1px solid #ced4da';
                textarea.style.whiteSpace = 'pre-wrap';
                textarea.style.wordWrap = 'break-word';

                editableElement.style.display = 'none';
                if (editableElement.previousElementSibling) editableElement.previousElementSibling.style.display = 'none';
                
                contentDiv.appendChild(textarea);
                textarea.focus();

                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });

                const saveButton = document.createElement('button');
                saveButton.className = 'action-btn save-btn';
                saveButton.textContent = 'Save';
                saveButton.onclick = () => saveEdit(sessionId, turnIndex, fieldName, textarea.value, () => exitEditMode(editButton, contentDiv, textarea, controls));

                const cancelButton = document.createElement('button');
                cancelButton.className = 'action-btn cancel-btn';
                cancelButton.textContent = 'Cancel';
                cancelButton.onclick = () => exitEditMode(editButton, contentDiv, textarea, controls);

                const buttonContainer = document.createElement('div');
                buttonContainer.style.textAlign = 'right';
                buttonContainer.appendChild(saveButton);
                buttonContainer.appendChild(cancelButton);

                controls.style.visibility = 'hidden';
                controls.parentElement.appendChild(buttonContainer);
            }

            function exitEditMode(editButton, contentDiv, textarea, controls) {
                const editableElement = contentDiv.querySelector('.editable');
                editableElement.style.display = 'block';
                if (editableElement.previousElementSibling) editableElement.previousElementSibling.style.display = 'block';
                
                textarea.remove();
                const buttonContainer = controls.parentElement.querySelector('div[style="text-align: right;"]');
                if (buttonContainer) buttonContainer.remove();
                
                controls.style.visibility = 'visible';
            }

            function saveEdit(sessionId, turnIndex, fieldName, newContent, callback) {
                const payload = { [fieldName]: newContent };

                fetch(`/api/session/${sessionId}/turn/${turnIndex}/edit`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                    .then(handleResponse)
                    .then(data => {
                        if (data.success) {
                            const turnElement = document.getElementById(`turn-${turnIndex}`);
                            const turnType = turnElement.classList.contains('model_response') || turnElement.classList.contains('condensed_history') ? 'model_response' : 'user_task';
                            
                            if (turnType === 'model_response') {
                                const renderedDiv = turnElement.querySelector('.rendered-markdown');
                                const rawDiv = turnElement.querySelector('.raw-markdown');
                                rawDiv.textContent = newContent;
                                if(window.marked) {
                                    renderedDiv.innerHTML = marked.parse(newContent);
                                }
                            } else {
                                turnElement.querySelector('.editable').textContent = newContent;
                            }
                            callback();
                        } else { throw new Error(data.message); }
                    })
                    .catch(handleError);
            }

            function toggleMetaEdit(editButton, sessionId) {
                const viewContainer = document.getElementById('session-meta-view');
                const fields = {
                    purpose: viewContainer.querySelector('[data-field="purpose"]'),
                    background: viewContainer.querySelector('[data-field="background"]'),
                    multi_step_reasoning_enabled: viewContainer.querySelector('[data-field="multi_step_reasoning_enabled"]'),
                    hyperparameters: viewContainer.querySelector('[data-field="hyperparameters"]')
                };

                const inputs = {
                    purpose: document.createElement('textarea'),
                    background: document.createElement('textarea'),
                    multi_step_reasoning_enabled: document.createElement('input'),
                    hyperparameters: {
                        container: document.createElement('div'),
                        temperature: document.createElement('input'),
                        top_p: document.createElement('input'),
                        top_k: document.createElement('input')
                    }
                };

                inputs.purpose.value = fields.purpose.textContent.trim();
                inputs.background.value = fields.background.textContent.trim();
                inputs.multi_step_reasoning_enabled.type = 'checkbox';
                inputs.multi_step_reasoning_enabled.checked = fields.multi_step_reasoning_enabled.textContent.trim() === 'Enabled';

                const currentHyperparams = {{ session_data.hyperparameters | default({}) | tojson | safe }};
                const hpContainer = inputs.hyperparameters.container;
                hpContainer.style.display = 'grid';
                hpContainer.style.gap = '10px';

                // Temperature
                const tempLabel = document.createElement('label');
                tempLabel.innerHTML = `Temperature: <span id="edit-temperature-value">${currentHyperparams.temperature.value}</span>`;
                inputs.hyperparameters.temperature.type = 'range';
                inputs.hyperparameters.temperature.min = '0';
                inputs.hyperparameters.temperature.max = '2';
                inputs.hyperparameters.temperature.step = '0.1';
                inputs.hyperparameters.temperature.value = currentHyperparams.temperature.value;
                inputs.hyperparameters.temperature.addEventListener('input', (e) => {
                    document.getElementById('edit-temperature-value').textContent = e.target.value;
                });
                hpContainer.appendChild(tempLabel);
                hpContainer.appendChild(inputs.hyperparameters.temperature);

                // Top P
                const topPLabel = document.createElement('label');
                topPLabel.innerHTML = `Top P: <span id="edit-top_p-value">${currentHyperparams.top_p.value}</span>`;
                inputs.hyperparameters.top_p.type = 'range';
                inputs.hyperparameters.top_p.min = '0';
                inputs.hyperparameters.top_p.max = '1';
                inputs.hyperparameters.top_p.step = '0.1';
                inputs.hyperparameters.top_p.value = currentHyperparams.top_p.value;
                inputs.hyperparameters.top_p.addEventListener('input', (e) => {
                    document.getElementById('edit-top_p-value').textContent = e.target.value;
                });
                hpContainer.appendChild(topPLabel);
                hpContainer.appendChild(inputs.hyperparameters.top_p);

                // Top K
                const topKLabel = document.createElement('label');
                topKLabel.innerHTML = `Top K: <span id="edit-top_k-value">${currentHyperparams.top_k.value}</span>`;
                inputs.hyperparameters.top_k.type = 'range';
                inputs.hyperparameters.top_k.min = '1';
                inputs.hyperparameters.top_k.max = '50';
                inputs.hyperparameters.top_k.step = '1';
                inputs.hyperparameters.top_k.value = currentHyperparams.top_k.value;
                inputs.hyperparameters.top_k.addEventListener('input', (e) => {
                    document.getElementById('edit-top_k-value').textContent = e.target.value;
                });
                hpContainer.appendChild(topKLabel);
                hpContainer.appendChild(inputs.hyperparameters.top_k);

                const label = document.createElement('label');
                label.textContent = ' Enable Multi-step Reasoning';

                Object.values(fields).forEach(p => { if(p) p.style.display = 'none'; });
                fields.purpose.parentElement.appendChild(inputs.purpose);
                fields.background.parentElement.appendChild(inputs.background);
                fields.multi_step_reasoning_enabled.parentElement.appendChild(inputs.multi_step_reasoning_enabled);
                fields.multi_step_reasoning_enabled.parentElement.appendChild(label);
                if (fields.hyperparameters) fields.hyperparameters.parentElement.appendChild(hpContainer);
                
                editButton.style.display = 'none';

                const saveButton = document.createElement('button');
                saveButton.className = 'action-btn save-btn';
                saveButton.textContent = 'Save Meta';
                saveButton.onclick = () => saveMetaEdit(sessionId, inputs);

                const cancelButton = document.createElement('button');
                cancelButton.className = 'action-btn cancel-btn';
                cancelButton.textContent = 'Cancel';
                cancelButton.onclick = () => window.location.reload();

                viewContainer.appendChild(saveButton);
                viewContainer.appendChild(cancelButton);
            }

            function saveMetaEdit(sessionId, inputs) {
                const payload = {
                    purpose: inputs.purpose.value,
                    background: inputs.background.value,
                    multi_step_reasoning_enabled: inputs.multi_step_reasoning_enabled.checked,
                    hyperparameters: {
                        temperature: { value: parseFloat(inputs.hyperparameters.temperature.value) },
                        top_p: { value: parseFloat(inputs.hyperparameters.top_p.value) },
                        top_k: { value: parseInt(inputs.hyperparameters.top_k.value, 10) }
                    }
                };

                fetch(`/api/session/${sessionId}/meta/edit`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                    .then(handleResponse)
                    .then(data => data.success ? window.location.reload() : Promise.reject(new Error(data.message)))
                    .catch(handleError);
            }

            function sendInstruction(sessionId) {
                const instructionTextarea = document.getElementById('new-instruction-text');
                const instruction = instructionTextarea.value.trim();
                if (!instruction) return alert('Instruction cannot be empty.');

                const sendButton = document.querySelector('.send-instruction-btn');
                sendButton.disabled = true;
                const originalButtonText = sendButton.textContent;
                sendButton.textContent = 'Sending...';

                const turnsList = document.getElementById('turns-list-section');
                const placeholderTurn = document.createElement('div');
                placeholderTurn.className = 'turn model_response';
                placeholderTurn.innerHTML = `
                    <div class="turn-header">
                        <span><strong>...</strong>: Model</span>
                    </div>
                    <div class="turn-content">
                        <div class="rendered-markdown markdown-body"></div>
                    </div>
                `;
                turnsList.insertBefore(placeholderTurn, turnsList.firstChild);
                const responseContainer = placeholderTurn.querySelector('.rendered-markdown');

                let fullResponse = '';

                fetch(`/api/session/${sessionId}/instruction`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instruction })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    function processStream() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                // Stream finished, reload to get the final state
                                window.location.reload();
                                return;
                            }

                            buffer += decoder.decode(value, { stream: true });
                            
                            let boundary = buffer.indexOf('\n\n');
                            while (boundary !== -1) {
                                const message = buffer.substring(0, boundary);
                                buffer = buffer.substring(boundary + 2);

                                if (message.startsWith('event: end')) {
                                    reader.cancel();
                                    window.location.reload();
                                    return;
                                }
                                
                                if (message.startsWith('data:')) {
                                    try {
                                        const data = JSON.parse(message.substring(5));
                                        if (data.content) {
                                            fullResponse += data.content;
                                            responseContainer.innerHTML = marked.parse(fullResponse);
                                        }
                                        if (data.error) {
                                            responseContainer.innerHTML = `<p style="color: red;"><strong>Error:</strong></p><pre>${data.error}</pre>`;
                                            sendButton.disabled = false;
                                            sendButton.textContent = originalButtonText;
                                            reader.cancel();
                                            return;
                                        }
                                    } catch (e) {
                                        console.error("Failed to parse stream data:", e);
                                    }
                                }
                                boundary = buffer.indexOf('\n\n');
                            }
                            processStream();
                        }).catch(error => {
                            handleError(error);
                            sendButton.disabled = false;
                            sendButton.textContent = originalButtonText;
                        });
                    }
                    processStream();
                })
                .catch(error => {
                    handleError(error);
                    sendButton.disabled = false;
                    sendButton.textContent = originalButtonText;
                });
            }

            const newInstructionText = document.getElementById('new-instruction-text');
            if (newInstructionText) newInstructionText.focus();

            document.getElementById('todos-list')?.addEventListener('change', function(event) {
                if (event.target.classList.contains('todo-checkbox')) {
                    const checkbox = event.target;
                    const index = parseInt(checkbox.dataset.index, 10);
                    const sessionId = document.getElementById('current-session-id').value;
                    
                    let todos = {{ session_data.todos | tojson | safe if session_data.todos else '[]' }};

                    if (todos[index]) {
                        todos[index].checked = checkbox.checked;
                    }

                    saveTodos(sessionId, todos);
                }
            });

            function saveTodos(sessionId, todos) {
                const payload = { todos };

                fetch(`/api/session/${sessionId}/todos/edit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(handleResponse)
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.message);
                    }
                    console.log("Todos saved successfully.");
                })
                .catch(error => {
                    handleError(error);
                });
            }

            document.getElementById('references-list')?.addEventListener('change', function(event) {
                if (event.target.classList.contains('reference-checkbox')) {
                    const sessionId = document.getElementById('current-session-id').value;
                    let references = {{ session_data.references | tojson | safe if session_data.references else '[]' }};
                    
                    const checkbox = event.target;
                    const index = parseInt(checkbox.dataset.index, 10);
                    if (references[index]) {
                        references[index].disabled = !checkbox.checked;
                    }

                    const label = checkbox.closest('label');
                    const span = label.querySelector('span');
                    if (checkbox.checked) {
                        span.style.textDecoration = 'none';
                        span.style.color = 'inherit';
                    } else {
                        span.style.textDecoration = 'line-through';
                        span.style.color = '#888';
                    }

                    saveReferences(sessionId, references);
                }
            });

            document.getElementById('toggle-references-btn')?.addEventListener('click', function() {
                const sessionId = document.getElementById('current-session-id').value;
                let references = {{ session_data.references | tojson | safe if session_data.references else '[]' }};
                const shouldCheckAll = references.some(ref => ref.disabled);
                references.forEach(ref => ref.disabled = !shouldCheckAll);
                saveReferences(sessionId, references, true); // Pass true to reload
            });

            function saveReferences(sessionId, references, reload = false) {
                const payload = { references };

                fetch(`/api/session/${sessionId}/references/edit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(handleResponse)
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.message);
                    }
                    console.log("References saved successfully.");
                    if (reload) {
                        window.location.reload();
                    }
                })
                .catch(error => {
                    handleError(error);
                    window.location.reload();
                });
            }

        }); // End DOMContentLoaded
    </script>
</body>
</html>