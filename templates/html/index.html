<!DOCTYPE html>
<html lang="en" data-color-mode="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conductor Sessions</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css">
</head>
<body
    data-timezone="{{ settings.get('timezone', 'UTC') }}"
    data-session-turns-count="{% if current_session_id %}{{ session_data.turns | length }}{% else %}0{% endif %}"
    data-expert-mode="{{ expert_mode | tojson }}"
    data-current-session-id="{{ current_session_id }}"
    data-session-data='{{ session_data | tojson | safe if session_data and session_data.turns else "{}" }}'
>
    <!-- Column 1: Session List -->
    <div id="sessions-column" class="column">
        <h2>Sessions</h2>
        <button class="action-btn save-btn" style="width: 100%; margin-bottom: 15px;" id="new-chat-button">+ New Chat</button>
        <ul>
            {% for session_id, meta in sessions %}
            <li>
                <a href="{{ url_for('view_session', session_id=session_id) }}" class="{{ 'active' if session_id == current_session_id else '' }}">
                    {{ meta.purpose }}
                    <span class="session-id">{{ session_id }}</span>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
    <!-- Column 2: Turns List -->
    <div id="turns-column" class="column">
        {% if current_session_id %}
        <div id="turns-column-header" style="position: sticky; top: 0; background-color: #f0f2f5; padding: 10px 20px; border-bottom: 1px solid #dee2e6; z-index: 5;">
            <h2>{{ session_data.purpose }} {% if context_limit > 0 and token_count is not none %}({{ ((context_limit - token_count) / context_limit * 100) | round(0, 'floor') }}% context left){% endif %}</h2>
        </div>
        {% endif %}
        {% if current_session_id %}
        <section id="turns-list-section" style="padding: 20px; display: flex; flex-direction: column; gap: 15px;">
            {% for turn in turns %}
                <div class="turn {{ turn.type }}" id="turn-{{ loop.index0 }}">
                                            <div class="turn-header">
                                            <span>
                                                <strong style="color: #007bff; margin-right: 10px;">{{ loop.index }}:</strong>
                                                                            {% if turn.type == 'user_task' %}You
                                                                            {% elif turn.type == 'model_response' %}Model
                                                                            {% elif turn.type == 'function_calling' %}Function Calling
                                                                            {% elif turn.type == 'tool_response' %}Tool Response
                                                                            {% elif turn.type == 'compressed_history' %}Compressed
                                                                            {% else %}Unknown{% endif %}                                                <span style="font-weight: normal; color: #999; margin-left: 10px;">{{ turn.timestamp.replace('T', ' ').split('.')[0] if turn.timestamp else '' }}</span>
                                            </span>                        <div class="turn-header-controls">
                            {% if turn.type == 'model_response' %}
                            <button class="action-btn fork-btn" data-session-id="{{ current_session_id }}" data-fork-index="{{ loop.index0 }}">Fork</button>
                            {% endif %}
                            <button class="action-btn copy-turn-btn" data-turn-index="{{ loop.index0 }}">Copy</button>
                            {% if expert_mode %}
                            <button class="action-btn edit-btn" data-session-id="{{ current_session_id }}" data-turn-index="{{ loop.index0 }}" data-turn-type="{{ turn.type }}">Edit</button>
                            <button class="action-btn delete-btn" data-session-id="{{ current_session_id }}" data-turn-index="{{ loop.index0 }}">Delete</button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="turn-content">
                        {% if turn.type == 'user_task' %}
                            <pre class="editable" data-field="instruction">{{ turn.instruction }}</pre>
                        {% elif turn.type == 'model_response' or turn.type == 'compressed_history' %}
                            {% if turn.type == 'compressed_history' %}<p><strong><em>-- History Compressed --</em></strong></p>{% endif %}
                            <div class="raw-markdown" style="display: none;">{{ turn.content }}</div>
                            <div class="rendered-markdown markdown-body editable" data-field="content"></div>
                        {% elif turn.type == 'function_calling' %}
                            <pre>{{ turn.response }}</pre>
                        {% elif turn.type == 'tool_response' %}
                            <div class="tool-response-content">
                                <strong>Status: </strong>
                                <span class="status-{{ turn.response.status }}">{{ turn.response.status }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="welcome-message">
                <h1>Welcome</h1>
                <p>Select a session from the sidebar to view its details.</p>
            </div>
        {% endif %}
    </div>
    <!-- Column 3: Meta & Actions -->
    <div id="meta-column" class="column">
        {% if current_session_id %}
            <input type="hidden" id="current-session-id" value="{{ current_session_id }}">
            <section style="flex: 5 0 0; display: flex; flex-direction: column; box-sizing: border-box; min-height: 0;">
                <h3>Session Meta</h3>
                <div class="session-meta" id="session-meta-view" style="flex: 1; overflow-y: auto;">
                    <div class="meta-item">
                        <strong>Purpose:</strong>
                        <p class="editable-meta" data-field="purpose">{{ session_data.purpose }}</p>
                    </div>
                    <div class="meta-item">
                        <strong>Background:</strong>
                        <p class="editable-meta" data-field="background">{{ session_data.background }}</p>
                    </div>
                    <div class="meta-item">
                        <strong>Roles:</strong>
                        <p class="editable-meta" data-field="roles">{{ session_data.roles | join(', ') }}</p>
                    </div>
                    <div class="meta-item">
                        <strong>Multi-step Reasoning:</strong>
                        <p class="editable-meta" data-field="multi_step_reasoning_enabled">{{ "Enabled" if session_data.multi_step_reasoning_enabled else "Disabled" }}</p>
                    </div>
                    <div class="meta-item">
                        <strong>Hyperparameters:</strong>
                        {% if session_data.hyperparameters %}
                            <p class="editable-meta" data-field="hyperparameters">
                                Temp: {{ session_data.hyperparameters.temperature.value }},
                                Top P: {{ session_data.hyperparameters.top_p.value }},
                                Top K: {{ session_data.hyperparameters.top_k.value }}
                            </p>
                        {% endif %}
                    </div>
                    <div class="meta-item">
                        <strong>Todos:</strong>
                        <button class="action-btn" id="delete-todos-btn" data-session-id="{{ current_session_id }}" style="float: right; margin-bottom: 5px; background-color: #dc3545;">Delete All</button>
                        {% if session_data.todos and session_data.todos|length > 0 %}
                            <ul id="todos-list" style="list-style: none; padding-left: 0;">
                                {% for todo in session_data.todos %}
                                    <li style="margin-bottom: 10px;">
                                        <label style="cursor: pointer;">
                                            <input type="checkbox" class="todo-checkbox" data-index="{{ loop.index0 }}" {% if todo.checked %}checked{% endif %} style="margin-right: 8px;">
                                            <strong style="display: inline;">{{ todo.item }}</strong>
                                        </label>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>No todos for this session.</p>
                        {% endif %}
                    </div>
                    <div class="meta-item">
                        <strong>References:</strong>
                        <button class="action-btn" id="toggle-references-btn" data-session-id="{{ current_session_id }}" style="float: right; margin-bottom: 5px;">Toggle All</button>
                        {% if session_data.references and session_data.references|length > 0 %}
                            <ul id="references-list" style="list-style: none; padding-left: 0;">
                                {% for reference in session_data.references %}
                                    <li style="margin-bottom: 10px;">
                                        <label style="cursor: pointer; display: flex; align-items: center;">
                                            <input type="checkbox" class="reference-checkbox" data-index="{{ loop.index0 }}" {% if not reference.disabled %}checked{% endif %} style="margin-right: 8px;">
                                            <span style="word-break: break-all; {% if reference.disabled %}text-decoration: line-through; color: #888;{% endif %}">{{ reference.path }}</span>
                                        </label>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>No references for this session.</p>
                        {% endif %}
                    </div>
                </div>
                <button class="action-btn edit-meta-btn" data-session-id="{{ current_session_id }}">Edit Meta</button>
            </section>
            <section style="flex: 1; box-sizing: border-box;">
                <h3>Session Control</h3>
                <div class="session-actions">
                    <button class="action-btn delete-session-btn" data-session-id="{{ current_session_id }}">Delete Session</button>
                </div>
            </section>
            <section class="new-instruction-control" style="flex: 4; display: flex; flex-direction: column; box-sizing: border-box;">
                <h3>New Instruction</h3>
                <textarea id="new-instruction-text" placeholder="Enter your instruction here..." style="width: 100%; flex: 1; min-height: 80px; margin-bottom: 10px;"></textarea>
                <button class="action-btn send-instruction-btn" data-session-id="{{ current_session_id }}">Send Instruction</button>
            </section>
        {% endif %}
    </div>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
    